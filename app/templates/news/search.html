<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>News Search</title>
   <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
   <!-- Include marked.js for Markdown rendering -->
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
       /* Add some basic styling for markdown content */
       .markdown-content h2 {
           font-size: 1.25rem;
           font-weight: 600;
           margin-top: 1rem;
           margin-bottom: 0.5rem;
       }
       .markdown-content ul {
           list-style-type: disc;
           margin-left: 1.5rem;
           margin-bottom: 1rem;
       }
       .markdown-content li {
           margin-bottom: 0.25rem;
       }
   </style>
</head>
<body class="bg-gray-50">
   <div class="container mx-auto p-4">
       <h1 class="text-2xl font-bold mb-6">News Search</h1>

       <div class="bg-white rounded-xl shadow p-6 mb-6">
           <form id="searchForm">
               <label for="symbol" class="block text-gray-700 text-lg mb-2">Stock Symbol</label>
               <input type="text" 
                      id="symbol" 
                      name="symbol" 
                      value="{{ search_params.get('symbol') or '' }}"
                      placeholder="NASDAQ:AAPL" 
                      class="w-full p-4 text-lg rounded-xl border border-gray-200 mb-4">
               
               <button type="submit" 
                       id="searchButton" 
                       class="w-full bg-blue-500 text-white p-4 rounded-xl text-lg font-medium hover:bg-blue-600 transition-colors">
                   Search News
               </button>
           </form>
       </div>

       <div class="bg-white rounded-xl shadow p-6">
           <div id="resultsCount" class="text-lg text-gray-600 mb-4">
               {% if articles %}{{ articles|length }} articles found{% endif %}
           </div>

           <div id="articlesContainer" class="space-y-6">
               {% if articles %}
                   {% for article in articles %}
                   <div class="border-b border-gray-100 pb-6 last:border-b-0">
                       <a href="{{ article.url }}" target="_blank" class="block text-blue-500 text-lg font-medium mb-2 hover:text-blue-600">
                           {{ article.title }}
                       </a>
                       <div class="text-gray-500 mb-2">Published on: {{ article.published_at }}</div>
                       
                       <!-- AI Summary -->
                       <div class="text-gray-600 mb-4 markdown-content">{{ article.summary.ai_summary | safe }}</div>
                       
                       <!-- AI Insights -->
                       <div class="text-gray-600 mb-4 markdown-content">{{ article.summary.ai_insights | safe }}</div>
                       

                       <!-- AI Sentiment Rating -->
                       {% if article.summary.ai_sentiment_rating is not none %}
                       <div class="mt-2 flex items-center space-x-2">
                           <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-sm font-medium
                               {% if article.summary.ai_sentiment_rating > 50 %}bg-green-200 text-green-900 border border-green-300
                               {% elif article.summary.ai_sentiment_rating > 10 %}bg-green-100 text-green-800 border border-green-200
                               {% elif article.summary.ai_sentiment_rating >= -10 %}bg-gray-100 text-gray-800 border border-gray-200
                               {% elif article.summary.ai_sentiment_rating >= -50 %}bg-red-100 text-red-800 border border-red-200
                               {% else %}bg-red-200 text-red-900 border border-red-300{% endif %}">
                               {% if article.summary.ai_sentiment_rating > 50 %}Strong Positive
                               {% elif article.summary.ai_sentiment_rating > 10 %}Positive
                               {% elif article.summary.ai_sentiment_rating >= -10 %}Neutral
                               {% elif article.summary.ai_sentiment_rating >= -50 %}Negative
                               {% else %}Strong Negative{% endif %}
                               ({{ article.summary.ai_sentiment_rating }})
                           </span>
                       </div>
                       {% endif %}
                   </div>
                   {% endfor %}
               {% endif %}
           </div>
       </div>
   </div>

   <script>
       document.addEventListener('DOMContentLoaded', () => {
           const searchForm = document.getElementById('searchForm');
           const symbolInput = document.getElementById('symbol');
           const searchButton = document.getElementById('searchButton');
           const articlesContainer = document.getElementById('articlesContainer');
           const resultsCount = document.getElementById('resultsCount');

           const renderMarkdown = (markdown) => {
               return marked.parse(markdown || '');
           };

           searchForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               
               const symbol = symbolInput.value.trim();
               if (!symbol) {
                   alert('Please enter a stock symbol');
                   return;
               }

               try {
                   searchButton.disabled = true;
                   const params = new URLSearchParams({ symbol });
                   
                   const response = await fetch(`/news/search?${params}`, {
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest'
                       }
                   });

                   if (!response.ok) throw new Error('Search failed');
                   
                   const data = await response.json();
                   
                   if (data.articles?.length > 0) {
                       resultsCount.textContent = `${data.articles.length} articles found`;
                       articlesContainer.innerHTML = data.articles
                           .map(article => `
                               <div class="border-b border-gray-100 pb-6 last:border-b-0">
                                   <a href="${article.url}" target="_blank" class="block text-blue-500 text-lg font-medium mb-2 hover:text-blue-600">
                                       ${article.title}
                                   </a>
                                   <div class="text-gray-500 mb-2">Published on: ${article.published_at}</div>
                                   
                                   <!-- AI Summary -->
                                   <div class="text-gray-600 mb-4 markdown-content">
                                       ${renderMarkdown(article.summary.ai_summary)}
                                   </div>
                                   
                                   <!-- AI Insights -->
                                   <div class="text-gray-600 mb-4 markdown-content">
                                       ${renderMarkdown(article.summary.ai_insights)}
                                   </div>

                                   <div class="mt-2 flex flex-wrap gap-1">
                                        <span class="text-sm text-gray-600 mr-2">Related Symbols:</span>
                                         ${article.symbols | join(', ') || 'None'}
                                    </div>

                                   <!-- AI Sentiment Rating -->
                                   ${article.summary.ai_sentiment_rating != null ? 
                                       `<div class="mt-2 flex items-center space-x-2">
                                           <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-sm font-medium ${
                                               article.summary.ai_sentiment_rating > 50 ? 'bg-green-200 text-green-900 border border-green-300' :
                                               article.summary.ai_sentiment_rating > 10 ? 'bg-green-100 text-green-800 border border-green-200' :
                                               article.summary.ai_sentiment_rating >= -10 ? 'bg-gray-100 text-gray-800 border border-gray-200' :
                                               article.summary.ai_sentiment_rating >= -50 ? 'bg-red-100 text-red-800 border border-red-200' :
                                               'bg-red-200 text-red-900 border border-red-300'
                                           }">
                                               ${article.summary.ai_sentiment_rating > 50 ? 'Strong Positive' :
                                                 article.summary.ai_sentiment_rating > 10 ? 'Positive' :
                                                 article.summary.ai_sentiment_rating >= -10 ? 'Neutral' :
                                                 article.summary.ai_sentiment_rating >= -50 ? 'Negative' :
                                                 'Strong Negative'}
                                               (${article.summary.ai_sentiment_rating})
                                           </span>
                                       </div>` : ''
                                   }
                               </div>
                           `).join('');
                   } else {
                       resultsCount.textContent = 'No articles found';
                       articlesContainer.innerHTML = '';
                   }
               } catch (error) {
                   console.error('Search error:', error);
                   alert('Failed to search news: ' + error.message);
               } finally {
                   searchButton.disabled = false;
               }
           });
       });
   </script>
</body>
</html>