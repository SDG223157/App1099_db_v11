<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>News Search</title>
   <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
       .markdown-content h2 {
           font-size: 1.25rem;
           font-weight: 600;
           margin-top: 1rem;
           margin-bottom: 0.5rem;
       }
       .markdown-content ul {
           list-style-type: disc;
           margin-left: 1.5rem;
           margin-bottom: 1rem;
       }
       .markdown-content li {
           margin-bottom: 0.25rem;
       }
   </style>
</head>
<body class="bg-gray-50">
   <div class="container mx-auto p-4">
       <h1 class="text-2xl font-bold mb-6">News Search</h1>

       <div class="mb-8">
           <form id="searchForm" method="GET" action="{{ url_for('news.search') }}" class="space-y-4">
               <div class="flex flex-col space-y-2">
                   <label for="symbol" class="text-gray-700 font-medium">Enter Stock Symbol or Special Keyword:</label>
                   <div class="flex space-x-4">
                       <input type="text" 
                              id="symbol" 
                              name="symbol" 
                              value="{{ search_params.symbol }}"
                              class="form-input rounded-md border-gray-300 shadow-sm w-full"
                              placeholder="Enter symbol (e.g., AAPL) or keyword (latest/highest/lowest)">
                       <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                           Search
                       </button>
                   </div>
               </div>
               
               <!-- Special keywords helper -->
               <div class="text-sm text-gray-600">
                   <p>Special keywords:</p>
                   <ul class="list-disc list-inside ml-4">
                       <li><strong>latest</strong> - Most recent articles</li>
                       <li><strong>highest</strong> - Highest sentiment rated articles</li>
                       <li><strong>lowest</strong> - Lowest sentiment rated articles</li>
                   </ul>
               </div>
           </form>
       </div>

       <div id="resultsCount" class="text-lg text-gray-600 mb-4">
           {% if articles and articles.total > 0 %}
               Showing {{ (articles.page - 1) * 5 + 1 }}-{{ min(articles.page * 5, articles.total) }} 
               of {{ articles.total }} articles
           {% elif search_params.symbol %}
               No articles found for "{{ search_params.symbol }}"
           {% endif %}
       </div>

       <div id="articlesContainer" class="space-y-6">
           {% if articles and articles.items %}
               {% for article in articles.items %}
               <div class="border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                   <a href="{{ article.url }}" target="_blank" 
                      class="block text-blue-500 text-lg font-medium mb-2 hover:text-blue-600">
                       {{ article.title }}
                   </a>
                   
                   <div class="text-gray-500 mb-2">
                       Published: {{ article.published_at.strftime('%Y-%m-%d %H:%M:%S') }}
                   </div>

                   {% if article.ai_summary %}
                   <div class="text-gray-600 mb-4 markdown-content">
                       <h3 class="font-medium text-gray-700 mb-1">AI Summary:</h3>
                       {{ article.ai_summary | safe }}
                   </div>
                   {% endif %}

                   {% if article.ai_insights %}
                   <div class="text-gray-600 mb-4 markdown-content">
                       <h3 class="font-medium text-gray-700 mb-1">AI Insights:</h3>
                       {{ article.ai_insights | safe }}
                   </div>
                   {% endif %}

                   {% if article.ai_sentiment_rating is not none %}
                   <div class="text-sm text-gray-500">
                       Sentiment Rating: 
                       <span class="font-medium 
                           {% if article.ai_sentiment_rating > 0.6 %}text-green-600
                           {% elif article.ai_sentiment_rating < 0.4 %}text-red-600
                           {% else %}text-yellow-600{% endif %}">
                           {{ "%.2f"|format(article.ai_sentiment_rating) }}
                       </span>
                   </div>
                   {% endif %}
               </div>
               {% endfor %}

               {% if articles.pages > 1 %}
               <div class="flex justify-center space-x-2 mt-6">
                   {% if articles.has_prev %}
                   <a href="{{ url_for('news.search', page=articles.prev_num, symbol=search_params.symbol) }}"
                      class="px-3 py-1 border rounded hover:bg-gray-100">Previous</a>
                   {% endif %}

                   {% for page_num in articles.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                       {% if page_num %}
                           {% if page_num == articles.page %}
                           <span class="px-3 py-1 border rounded bg-blue-500 text-white">
                               {{ page_num }}
                           </span>
                           {% else %}
                           <a href="{{ url_for('news.search', page=page_num, symbol=search_params.symbol) }}"
                              class="px-3 py-1 border rounded hover:bg-gray-100">
                               {{ page_num }}
                           </a>
                           {% endif %}
                       {% else %}
                           <span class="px-3 py-1">â€¦</span>
                       {% endif %}
                   {% endfor %}

                   {% if articles.has_next %}
                   <a href="{{ url_for('news.search', page=articles.next_num, symbol=search_params.symbol) }}"
                      class="px-3 py-1 border rounded hover:bg-gray-100">Next</a>
                   {% endif %}
               </div>
               {% endif %}
           {% endif %}
       </div>
   </div>

   <script>
       document.addEventListener('DOMContentLoaded', () => {
           const searchForm = document.getElementById('searchForm');
           const symbolInput = document.getElementById('symbol');
           const searchButton = document.getElementById('searchButton');
           const articlesContainer = document.getElementById('articlesContainer');
           const resultsCount = document.getElementById('resultsCount');

           const renderMarkdown = (markdown) => {
               return marked.parse(markdown || '');
           };

           // Function to handle symbol search when clicking related symbols
           window.searchSymbol = (symbol) => {
               symbolInput.value = symbol; // Set the symbol in the search input
               searchForm.dispatchEvent(new Event('submit')); // Trigger the search form submission
           };

           searchForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               
               const symbol = symbolInput.value.trim();
               if (!symbol) {
                   alert('Please enter a stock symbol or one of: latest, highest, lowest');
                   return;
               }

               try {
                   searchButton.disabled = true;
                   const params = new URLSearchParams({ symbol });
                   
                   const response = await fetch(`/news/search?${params}`, {
                       headers: {
                           'X-Requested-With': 'XMLHttpRequest'
                       }
                   });

                   if (!response.ok) throw new Error('Search failed');
                   
                   const data = await response.json();
                   
                   if (data.articles?.length > 0) {
                       resultsCount.textContent = `${data.articles.length} articles found`;
                       articlesContainer.innerHTML = data.articles
                           .map(article => `
                               <div class="border-b border-gray-100 pb-6 last:border-b-0">
                                   <a href="${article.url}" target="_blank" class="block text-blue-500 text-lg font-medium mb-2 hover:text-blue-600">
                                       ${article.title}
                                   </a>
                                   <div class="text-gray-500 mb-2">Published on: ${article.published_at}</div>
                                   
                                   <!-- AI Summary -->
                                   <div class="text-gray-600 mb-4 markdown-content">
                                       ${renderMarkdown(article.summary.ai_summary)}
                                   </div>
                                   
                                   <!-- AI Insights -->
                                   <div class="text-gray-600 mb-4 markdown-content">
                                       ${renderMarkdown(article.summary.ai_insights)}
                                   </div>

                                   <!-- Related Symbols -->
                                   ${article.symbols?.length > 0 ? `
                                       <div class="text-gray-600 mb-4">
                                           <span class="font-medium">Related Symbols:</span>
                                           <div class="flex flex-wrap gap-2 mt-2">
                                               ${article.symbols.map(symbol => `
                                                   <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-sm cursor-pointer hover:bg-gray-300"
                                                         onclick="searchSymbol('${symbol.symbol}')">
                                                       ${symbol.symbol}
                                                   </span>
                                               `).join('')}
                                           </div>
                                       </div>
                                   ` : ''}

                                   <!-- AI Sentiment Rating -->
                                   ${article.summary.ai_sentiment_rating != null ? 
                                       `<div class="mt-2 flex items-center space-x-2">
                                           <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-sm font-medium ${
                                               article.summary.ai_sentiment_rating > 50 ? 'bg-green-200 text-green-900 border border-green-300' :
                                               article.summary.ai_sentiment_rating > 10 ? 'bg-green-100 text-green-800 border border-green-200' :
                                               article.summary.ai_sentiment_rating >= -10 ? 'bg-gray-100 text-gray-800 border border-gray-200' :
                                               article.summary.ai_sentiment_rating >= -50 ? 'bg-red-100 text-red-800 border border-red-200' :
                                               'bg-red-200 text-red-900 border border-red-300'
                                           }">
                                               ${article.summary.ai_sentiment_rating > 50 ? 'Strong Positive' :
                                                 article.summary.ai_sentiment_rating > 10 ? 'Positive' :
                                                 article.summary.ai_sentiment_rating >= -10 ? 'Neutral' :
                                                 article.summary.ai_sentiment_rating >= -50 ? 'Negative' :
                                                 'Strong Negative'}
                                               (${article.summary.ai_sentiment_rating})
                                           </span>
                                       </div>` : ''
                                   }
                               </div>
                           `).join('');
                   } else {
                       resultsCount.textContent = 'No articles found';
                       articlesContainer.innerHTML = '';
                   }
               } catch (error) {
                   console.error('Search error:', error);
                   alert('Failed to search news: ' + error.message);
               } finally {
                   searchButton.disabled = false;
               }
           });
       });
   </script>
</body>
</html>