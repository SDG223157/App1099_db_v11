<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>News Search</title>
   <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
       .markdown-content h2 {
           font-size: 1.25rem;
           font-weight: 600;
           margin-top: 1rem;
           margin-bottom: 0.5rem;
       }
       .markdown-content ul {
           list-style-type: disc !important;
           padding-left: 1.5rem !important;
       }
       .markdown-content li {
           margin-bottom: 0.5rem !important;
       }
   </style>
</head>
<body class="bg-gray-50">
   <div class="container mx-auto p-4">
       <h1 class="text-2xl font-bold mb-6">News Search</h1>

       <div class="mb-8 flex justify-between items-center">
           <form id="searchForm" method="GET" action="{{ url_for('news.search') }}" class="space-y-4 flex-grow">
               <div class="flex flex-col space-y-2">
                   <label for="symbol" class="text-gray-700 font-medium">Enter Stock Symbol or Special Keyword:</label>
                   <div class="flex space-x-4">
                       <input type="text" 
                              id="symbol" 
                              name="symbol" 
                              value="{{ search_params.symbol }}"
                              class="form-input rounded-md border-gray-300 shadow-sm w-full"
                              placeholder="NASDAQ:AAPL or special keyword">
                       <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                           Search
                       </button>
                       <a href="{{ url_for('news.search') }}" 
                          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                           New Search
                       </a>
                   </div>
               </div>
               
               <!-- Special keywords helper -->
               <div class="text-sm text-gray-600">
                   <p>Special keywords:</p>
                   <ul class="list-disc list-inside ml-4">
                       <li><strong>latest</strong> - Most recent articles</li>
                       <li><strong>highest</strong> - Highest sentiment rated articles</li>
                       <li><strong>lowest</strong> - Lowest sentiment rated articles</li>
                   </ul>
               </div>
           </form>
       </div>

       <div id="resultsCount" class="text-lg text-gray-600 mb-4">
           {% if articles and articles.total > 0 %}
               Showing {{ (articles.page - 1) * 1 + 1 }}-{{ min(articles.page * 1, articles.total) }} 
               of {{ articles.total }} articles
           {% elif search_params.symbol %}
               No articles found for "{{ search_params.symbol }}"
           {% endif %}
       </div>

       <div id="articlesContainer" class="space-y-6">
           {% if articles and articles.items %}
               {% for article in articles.items %}
               <div class="border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                   <a href="{{ article.url }}" target="_blank" 
                      class="block text-blue-500 text-lg font-medium mb-2 hover:text-blue-600">
                       {{ article.title }}
                   </a>
                   
                   <div class="text-gray-500 mb-2">
                       Published: {{ article.published_at.strftime('%Y-%m-%d %H:%M:%S') }}
                       {% if article.symbols %}
                       <div class="mt-1">
                           Related Symbols: 
                           {% for symbol in article.symbols %}
                           <span class="bg-gray-100 px-2 py-1 rounded text-sm">
                               <a href="{{ url_for('news.search', symbol=symbol.symbol) }}" 
                                  class="text-blue-500 hover:text-blue-700">
                                   {{ symbol.symbol }}
                               </a>
                           </span>
                           {% endfor %}
                       </div>
                       {% endif %}
                   </div>

                   {% if article.ai_sentiment_rating is not none %}
                   <div class="text-sm text-gray-500 mt-2">
                       <span class="ml-2 px-2 py-1 rounded-full text-sm font-medium 
                           {% if article.ai_sentiment_rating > 50 %}bg-green-100 text-green-800
                           {% elif article.ai_sentiment_rating < -50 %}bg-red-100 text-red-800
                           {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                           AI Sentiment Rating {{ article.ai_sentiment_rating }}
                       </span>
                   </div>
                   {% endif %}

                   {% if article.ai_summary %}
                   <div class="text-gray-600 mb-4 markdown-content">
                       <h3 class="font-medium text-gray-700 mb-1">AI Summary:</h3>
                       {{ article.ai_summary|markdown|safe }}
                   </div>
                   {% endif %}

                   {% if article.ai_insights %}
                   <div class="text-gray-600 mb-4 markdown-content">
                       <h3 class="font-medium text-gray-700 mb-1">AI Insights:</h3>
                       {{ article.ai_insights|markdown|safe }}
                   </div>
                   {% endif %}
               </div>
               {% endfor %}

               {% if articles.pages > 1 %}
               <div class="flex justify-center space-x-2 mt-6">
                   {% if articles.has_prev %}
                   <a href="{{ url_for('news.search', page=articles.prev_num, symbol=search_params.symbol) }}"
                      class="px-3 py-1 border rounded hover:bg-gray-100">Previous</a>
                   {% endif %}

                   {% for page_num in articles.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                       {% if page_num %}
                           {% if page_num == articles.page %}
                           <span class="px-3 py-1 border rounded bg-blue-500 text-white">
                               {{ page_num }}
                           </span>
                           {% else %}
                           <a href="{{ url_for('news.search', page=page_num, symbol=search_params.symbol) }}"
                              class="px-3 py-1 border rounded hover:bg-gray-100">
                               {{ page_num }}
                           </a>
                           {% endif %}
                       {% else %}
                           <span class="px-3 py-1">â€¦</span>
                       {% endif %}
                   {% endfor %}

                   {% if articles.has_next %}
                   <a href="{{ url_for('news.search', page=articles.next_num, symbol=search_params.symbol) }}"
                      class="px-3 py-1 border rounded hover:bg-gray-100">Next</a>
                   {% endif %}
               </div>
               {% endif %}
           {% endif %}
       </div>
   </div>

   <script>
       document.addEventListener('DOMContentLoaded', () => {
           const searchForm = document.getElementById('searchForm');
           const symbolInput = document.getElementById('symbol');
           const articlesContainer = document.getElementById('articlesContainer');
           const resultsCount = document.getElementById('resultsCount');

           searchForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               
               const symbol = symbolInput.value.trim();
               if (!symbol) {
                   alert('Please enter a stock symbol or one of: latest, highest, lowest');
                   return;
               }

               try {
                   const params = new URLSearchParams({ symbol });
                   window.location.href = `/news/search?${params.toString()}`;
               } catch (error) {
                   console.error('Search error:', error);
                   alert('Failed to search news: ' + error.message);
               }
           });
       });
   </script>
</body>
</html>